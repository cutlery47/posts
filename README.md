# post
a tiny reddit ripoff

---

## Инструкция запуску / закрытию приложения
1) Клонируем репозиторий в произвольную директорию

```
git clone git@github.com:cutlery47/posts.git && cd posts
```

2) Настраиваем переменные окружения

В корневой директории проекта лежит файл example.env, следующего содержания:

```
POST_STORAGE_TYPE       =mem            (тип хранилища постов: mem - in-memory, pg - postgres (pg не импл.))
RESTORE_SOURCE          =dump           (файл, из которого восстанавливается in-memory хранилище)
DUMP_DESTINATION        =dump           (файл, в который пишется состояние in-memory хранлища)
DUMP_ENABLED            =true           (флаг, позволяющий отключить запись на диск)
DUMP_INTERVAL           =5s             (интервал, по истечении которого производится запись на диск)

USER_STORAGE_TYPE       =pg             (тип хранилища постов: mock - моковое хранилище, pg - postgres)
SESSION_DURATION        =24h            (длительность авторизационной сессии)

POSTGRES_USER           =postgres       (имя postgres-пользователя)
POSTGRES_PASSWORD       =12345          (пароль postgres-пользователя)
POSTGRES_HOST           =postgres       (адрес postgres-сервера)
POSTGRES_PORT           =5432           (порт postgres-сервера)
POSTGRES_DB             =posts          (имя postgres-БД)
POSTGRES_TIMEOUT        =5s             (тайм-аут на подключение к БД)
POSTGRES_MIGRATIONS     =./migrations   (директория с миграциями для БД)

BIND_ADDRESS            =0.0.0.0        (сетевой интерфейс, на котором слушает приложение)
BIND_PORT               =8000           (порт, на котором слушает приложение)
SHUTDOWN_TIMEOUT        =5s             (тайм-аут на чтение сервера)
READ_TIMEOUT            =5s             (тайм-аут на запись сервера)
WRITE_TIMEOUT           =5s             (тайм-аут на закрытие сервера)
```

Настоятельно не рекоммендуется изменять уже заданные значения :)

После заполнения пустых значений следует изменить название файла с example.env на .env

3) Запускаем приложение в Docker-контейнере

`make up_build`

4) Выходим из приложения

`make down`

## Инструкция по работе с приложением

После запуска приложения, Вы можете проверить статус работы сервиса:

`curl http://localhost:{ВАШ_ПОРТ}/ping`

При корректной работе возвращается пустой ответ

---

Перед началом работы непосредственно с постами необходимо авторизоваться

(Авторизация была реализована намеренно супер упрощенно)

Для авторизации приложение обрабатывает два эндпойнта:

Первый - регистрирует пользователя:

`POST: http://localhost:{ВАШ_ПОРТ}/api/v1/register`

JSON-тело запроса:

```
{
  "name": "ИМЯ ПОЛЬЗОВАТЕЛЯ",
  "role": "РОЛЬ ПОЛЬЗОВАТЕЛЯ"
}
```

Второй - выдает пользователю сессию

`POST: http://localhost:{ВАШ_ПОРТ}/api/v1/login`

JSON-тело запроса:

```
{
  "name": "ИМЯ ПОЛЬЗОВАТЕЛЯ",
  "role": "РОЛЬ ПОЛЬЗОВАТЕЛЯ"
}
```

Важно помнить, что каждая graphql-мутация требует от пользователя сессию
в качестве аргумента!

---

После получения id-сессии, можно взаимодействовать с graphql-эндпойнтом

`POST http://localhost:{ВАШ_ПОРТ}/api/v1/graphql`

При этом graphql-запросы должны прокидываться исключительно в теле http-запроса

---

Для ознакомления с graphql API следует обратиться к файлу schema.graphql 
в директории graphql